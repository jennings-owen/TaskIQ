services:
  # Backend Service (FastAPI) - Test Configuration
  # Usage: docker-compose -f docker-compose.test.yml up --abort-on-container-exit
  backend-test:
    build:
      context: .
      dockerfile: ./backend/Dockerfile
    container_name: synapseSquad-backend-test
    ports:
      - "8000:8000"
    environment:
      - BACKEND_PORT=8000
      - FRONT_END_URL=http://localhost:3000
      - TESTING=true
      - DATABASE_PATH=/app/tests/test.db
    volumes:
      # Mount backend code including test database
      - ./backend:/app
      # Preserve test.db for integration tests
      - ./backend/tests/test.db:/app/tests/test.db:ro
      # Prevent __pycache__ from being shared with host
      - /app/__pycache__
    command: >
      sh -c "
      echo 'Running backend tests...' &&
      pytest tests/ -v --tb=short --cov=. --cov-report=xml --cov-report=html --cov-report=term &&
      echo 'Starting backend service...' &&
      uvicorn main:app --host 0.0.0.0 --port 8000 --reload
      "
    networks:
      - synapseSquad-test-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/status')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Frontend Service (React) - Test Configuration
  frontend-test:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - REACT_APP_BACK_END_URL=http://localhost:8000
    container_name: synapseSquad-frontend-test
    ports:
      - "3000:3000"
    depends_on:
      backend-test:
        condition: service_healthy
    environment:
      - CI=true
      - REACT_APP_BACK_END_URL=http://backend-test:8000
    command: >
      sh -c "
      echo 'Running frontend tests...' &&
      npm test -- --coverage --watchAll=false --passWithNoTests &&
      echo 'Starting frontend service...' &&
      npm start
      "
    networks:
      - synapseSquad-test-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

networks:
  synapseSquad-test-network:
    driver: bridge
    name: synapseSquad-test-network

